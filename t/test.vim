" Test {{{1

try

let s:save_magic = &magic

let s:testcases1 = [
  \ {'v' : '\v(){}@%?=|+&<>.*~^$',
  \  'm' : '\m\(\)\{}\@\%\?\=\|\+\&\<\>.*~^$',
  \  'M' : '\M\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~^$',
  \  'V' : '\V\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~\^\$',
  \ },
  \ {'v' : '\v\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~\^\$',
  \  'm' : '\m(){}@%?=|+&<>\.\*\~\^\$',
  \  'M' : '\M(){}@%?=|+&<>.*~\^\$',
  \  'V' : '\V(){}@%?=|+&<>.*~^$',
  \ },
  \ {'v' : '\v[(){@%?=|+&<>.*~^$\\]',
  \  'm' : '\m[(){@%?=|+&<>.*~^$\\]',
  \  'M' : '\M\[(){@%?=|+&<>.*~^$\\]',
  \  'V' : '\V\[(){@%?=|+&<>.*~^$\\]',
  \ },
  \ {'v' : '\v[^(){@%?=|+&<>.*~^$\\]',
  \  'm' : '\m[^(){@%?=|+&<>.*~^$\\]',
  \  'M' : '\M\[^(){@%?=|+&<>.*~^$\\]',
  \  'V' : '\V\[^(){@%?=|+&<>.*~^$\\]',
  \ },
  \ {'v' : '\v[\^(){@%?=|+&<>.*~^$\\]',
  \  'm' : '\m[\^(){@%?=|+&<>.*~^$\\]',
  \  'M' : '\M\[\^(){@%?=|+&<>.*~^$\\]',
  \  'V' : '\V\[\^(){@%?=|+&<>.*~^$\\]',
  \ },
  \ {'v' : '\v\[(){@%?=|+&<>.*~^$]',
  \  'm' : '\m\[\(\)\{\@\%\?\=\|\+\&\<\>.*~^$]',
  \  'M' : '\M[\(\)\{\@\%\?\=\|\+\&\<\>\.\*\~^$]',
  \  'V' : '\V[\(\)\{\@\%\?\=\|\+\&\<\>\.\*\~\^\$]',
  \ },
  \ {'v' : '\v\[^(){@%?=|+&<>.*~^$]',
  \  'm' : '\m\[^\(\)\{\@\%\?\=\|\+\&\<\>.*~^$]',
  \  'M' : '\M[^\(\)\{\@\%\?\=\|\+\&\<\>\.\*\~^$]',
  \  'V' : '\V[\^\(\)\{\@\%\?\=\|\+\&\<\>\.\*\~\^\$]',
  \ },
  \ {'v' : '\v%[hoge]',
  \  'm' : '\m\%[hoge]',
  \  'M' : '\M\%[hoge]',
  \  'V' : '\V\%[hoge]',
  \ },
  \ {'v' : '\v\%[hoge]',
  \  'm' : '\m%[hoge]',
  \  'M' : '\M%\[hoge]',
  \  'V' : '\V%\[hoge]',
  \ },
  \ {'v' : '\v\_[hoge]',
  \  'm' : '\m\_[hoge]',
  \  'M' : '\M\_[hoge]',
  \  'V' : '\V\_[hoge]',
  \ },
  \ {'v' : '\v\\\_[hoge]',
  \  'm' : '\m\\\_[hoge]',
  \  'M' : '\M\\\_[hoge]',
  \  'V' : '\V\\\_[hoge]',
  \ },
  \ {'v' : '\v\\_[hoge]',
  \  'm' : '\m\\_[hoge]',
  \  'M' : '\M\\_\[hoge]',
  \  'V' : '\V\\_\[hoge]',
  \ },
  \ {'v' : '\v\\\\_[hoge]',
  \  'm' : '\m\\\\_[hoge]',
  \  'M' : '\M\\\\_\[hoge]',
  \  'V' : '\V\\\\_\[hoge]',
  \ },
  \ {'v' : '\v_[hoge]',
  \  'm' : '\m_[hoge]',
  \  'M' : '\M_\[hoge]',
  \  'V' : '\V_\[hoge]',
  \ },
  \ {'v' : '\v%[(){@%?=|+&<>^$\\]',
  \  'm' : '\m\%[(){@%?=|+&<>^$\\]',
  \  'M' : '\M\%[(){@%?=|+&<>^$\\]',
  \  'V' : '\V\%[(){@%?=|+&<>^$\\]',
  \ },
  \ {'v' : '\v\%[(){@%?=|+&<>^$]',
  \  'm' : '\m%[(){@%?=|+&<>^$]',
  \  'M' : '\M%\[(){@%?=|+&<>^$]',
  \  'V' : '\V%\[(){@%?=|+&<>^$]',
  \ },
  \ {'v' : '\v\_[(){@%?=|+&<>^$\\]',
  \  'm' : '\m\_[(){@%?=|+&<>^$\\]',
  \  'M' : '\M\_[(){@%?=|+&<>^$\\]',
  \  'V' : '\V\_[(){@%?=|+&<>^$\\]',
  \ },
  \ {'v' : '\v_[(){@%?=|+&<>^$\\]',
  \  'm' : '\m_[(){@%?=|+&<>^$\\]',
  \  'M' : '\M_\[(){@%?=|+&<>^$\\]',
  \  'V' : '\V_\[(){@%?=|+&<>^$\\]',
  \ },
  \ {'v' : '\v%(hoge)',
  \  'm' : '\m\%(hoge\)',
  \  'M' : '\M\%(hoge\)',
  \  'V' : '\V\%(hoge\)',
  \ },
  \ {'v' : '\v\%(hoge)',
  \  'm' : '\m%\(hoge\)',
  \  'M' : '\M%\(hoge\)',
  \  'V' : '\V%\(hoge\)',
  \ },
  \ {'v' : '\v\%\(hoge\)',
  \  'm' : '\m%(hoge)',
  \  'M' : '\M%(hoge)',
  \  'V' : '\V%(hoge)',
  \ },
  \ {'v' : '\v\\%(hoge)',
  \  'm' : '\m\\\%(hoge\)',
  \  'M' : '\M\\\%(hoge\)',
  \  'V' : '\V\\\%(hoge\)',
  \ },
  \ {'v' : '\v\\\\%(hoge)',
  \  'm' : '\m\\\\\%(hoge\)',
  \  'M' : '\M\\\\\%(hoge\)',
  \  'V' : '\V\\\\\%(hoge\)',
  \ },
  \ {'v' : '\v@=',
  \  'm' : '\m\@=',
  \  'M' : '\M\@=',
  \  'V' : '\V\@=',
  \ },
  \ {'v' : '\v@!',
  \  'm' : '\m\@!',
  \  'M' : '\M\@!',
  \  'V' : '\V\@!',
  \ },
  \ {'v' : '\v@<=',
  \  'm' : '\m\@<=',
  \  'M' : '\M\@<=',
  \  'V' : '\V\@<=',
  \ },
  \ {'v' : '\v@<!',
  \  'm' : '\m\@<!',
  \  'M' : '\M\@<!',
  \  'V' : '\V\@<!',
  \ },
  \ {'v' : '\v\@\=',
  \  'm' : '\m@=',
  \  'M' : '\M@=',
  \  'V' : '\V@=',
  \ },
  \ {'v' : '\v\@!',
  \  'm' : '\m@!',
  \  'M' : '\M@!',
  \  'V' : '\V@!',
  \ },
  \ {'v' : '\v\@\<\=',
  \  'm' : '\m@<=',
  \  'M' : '\M@<=',
  \  'V' : '\V@<=',
  \ },
  \ {'v' : '\v\@\<!',
  \  'm' : '\m@<!',
  \  'M' : '\M@<!',
  \  'V' : '\V@<!',
  \ },
  \ {'v' : '\v\%<''m',
  \  'm' : '\m%\<''m',
  \  'M' : '\M%\<''m',
  \  'V' : '\V%\<''m',
  \ },
  \ {'v' : '\v%<''m',
  \  'm' : '\m\%<''m',
  \  'M' : '\M\%<''m',
  \  'V' : '\V\%<''m',
  \ },
  \ {'v' : '\v\%\<''m',
  \  'm' : '\m%<''m',
  \  'M' : '\M%<''m',
  \  'V' : '\V%<''m',
  \ },
  \ {'v' : '\v\\\\%<''m',
  \  'm' : '\m\\\\\%<''m',
  \  'M' : '\M\\\\\%<''m',
  \  'V' : '\V\\\\\%<''m',
  \ },
  \ {'v' : '\v%>''m',
  \  'm' : '\m\%>''m',
  \  'M' : '\M\%>''m',
  \  'V' : '\V\%>''m',
  \ },
  \ {'v' : '\v\%>''m',
  \  'm' : '\m%\>''m',
  \  'M' : '\M%\>''m',
  \  'V' : '\V%\>''m',
  \ },
  \ {'v' : '\v\%\>''m',
  \  'm' : '\m%>''m',
  \  'M' : '\M%>''m',
  \  'V' : '\V%>''m',
  \ },
  \ {'v' : '\v\\\\%>''m',
  \  'm' : '\m\\\\\%>''m',
  \  'M' : '\M\\\\\%>''m',
  \  'V' : '\V\\\\\%>''m',
  \ },
  \ {'v' : '\v(^|[^\\])'.'(\\\\)*'.'\\\%'.'\ze%([<>])',
  \  'm' : '\m\(^\|[^\\]\)'.'\(\\\\\)*'.'\\%'.'\ze\%([<>]\)',
  \  'M' : '\M\(^\|\[^\\]\)'.'\(\\\\\)\*'.'\\%'.'\ze\%(\[<>]\)',
  \  'V' : '\V\(\^\|\[^\\]\)'.'\(\\\\\)\*'.'\\%'.'\ze\%(\[<>]\)',
  \ },
  \ {'v' : '\v(^|[^\\])'.'(\\\\\\\\\\\\)*'.'\\\%'.'\ze%([<>])',
  \  'm' : '\m\(^\|[^\\]\)'.'\(\\\\\\\\\\\\\)*'.'\\%'.'\ze\%([<>]\)',
  \  'M' : '\M\(^\|\[^\\]\)'.'\(\\\\\\\\\\\\\)\*'.'\\%'.'\ze\%(\[<>]\)',
  \  'V' : '\V\(\^\|\[^\\]\)'.'\(\\\\\\\\\\\\\)\*'.'\\%'.'\ze\%(\[<>]\)',
  \ },
  \ {'v' : '\v.{-}',
  \  'm' : '\m.\{-}',
  \  'M' : '\M\.\{-}',
  \  'V' : '\V\.\{-}',
  \ },
  \ {'v' : '\v^(.*|hoge)?$',
  \  'm' : '\m^\(.*\|hoge\)\?$',
  \  'M' : '\M^\(\.\*\|hoge\)\?$',
  \  'V' : '\V\^\(\.\*\|hoge\)\?\$',
  \ },
  \ {'v' : '\v%^',
  \  'm' : '\m\%^',
  \  'M' : '\M\%^',
  \  'V' : '\V\%^',
  \ },
  \ {'v' : '\v\%^',
  \  'm' : '\m%^',
  \  'M' : '\M%^',
  \  'V' : '\V%\^',
  \ },
  \ {'v' : '\v%$',
  \  'm' : '\m\%$',
  \  'M' : '\M\%$',
  \  'V' : '\V\%$',
  \ },
  \ {'v' : '\v\%$',
  \  'm' : '\m%$',
  \  'M' : '\M%$',
  \  'V' : '\V%\$',
  \ },
  \ {'v' : '\v%V',
  \  'm' : '\m\%V',
  \  'M' : '\M\%V',
  \  'V' : '\V\%V',
  \ },
  \ {'v' : '\v%#',
  \  'm' : '\m\%#',
  \  'M' : '\M\%#',
  \  'V' : '\V\%#',
  \ },
  \ {'v' : '\v%<''m',
  \  'm' : '\m\%<''m',
  \  'M' : '\M\%<''m',
  \  'V' : '\V\%<''m',
  \ },
  \ {'v' : '\v%>''m',
  \  'm' : '\m\%>''m',
  \  'M' : '\M\%>''m',
  \  'V' : '\V\%>''m',
  \ },
  \ {'v' : '\v%#',
  \  'm' : '\m\%#',
  \  'M' : '\M\%#',
  \  'V' : '\V\%#',
  \ },
  \ {'v' : '\v%23l',
  \  'm' : '\m\%23l',
  \  'M' : '\M\%23l',
  \  'V' : '\V\%23l',
  \ },
  \ ]

function! s:test_magicalize(from, to, func)
  let res = a:func(a:from)
  if res !=# a:to
    echom 'failed test'
    echom a:from . ' convert to below'
    echom 'got:' . res
    echom 'expected:' . a:to
  endif
endfunction

for s:testcase1 in s:testcases1
  for s:from in ['v', 'm', 'M', 'V']
    call s:test_magicalize(s:testcase1[s:from], s:testcase1['m'], function('magicalize#magicalize'))
    call s:test_magicalize(s:testcase1[s:from], s:testcase1['v'], function('magicalize#verymagicalize'))
    call s:test_magicalize(s:testcase1[s:from], s:testcase1['M'], function('magicalize#nomagicalize'))
    call s:test_magicalize(s:testcase1[s:from], s:testcase1['V'], function('magicalize#verynomagicalize'))
  endfor
endfor



let s:testcases2 = [
  \ {'from' : '\v()\m\{}\M\@\%\?\V\=\|\+\v&\m\<\M\>\M\.\M\*\M\~\M^\V\$',
  \  'v' : '\v(){}@%?=|+&<>.*~^$',
  \  'm' : '\m\(\)\{}\@\%\?\=\|\+\&\<\>.*~^$',
  \  'M' : '\M\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~^$',
  \  'V' : '\V\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~\^\$',
  \ },
  \ {'from' : '()\m\{}\M\@\%\?\V\=\|\+\v&\m\<\M\>\M\.\M\*\M\~\M^\V\$',
  \  'v' : '\v\(\){}@%?=|+&<>.*~^$',
  \  'm' : '\m()\{}\@\%\?\=\|\+\&\<\>.*~^$',
  \  'M' : '\M()\{}\@\%\?\=\|\+\&\<\>\.\*\~^$',
  \  'V' : '\V()\{}\@\%\?\=\|\+\&\<\>\.\*\~\^\$',
  \ },
  \ {'from' : '\(\)\{}\@\%\?\=\|\+\&\<\>.*~^$',
  \  'v' : '\v(){}@%?=|+&<>.*~^$',
  \  'm' : '\m\(\)\{}\@\%\?\=\|\+\&\<\>.*~^$',
  \  'M' : '\M\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~^$',
  \  'V' : '\V\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~\^\$',
  \ },
  \ {'from' : '(){}@%?=|+&<>\.\*\~\^\$',
  \  'v' : '\v\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~\^\$',
  \  'm' : '\m(){}@%?=|+&<>\.\*\~\^\$',
  \  'M' : '\M(){}@%?=|+&<>.*~\^\$',
  \  'V' : '\V(){}@%?=|+&<>.*~^$',
  \ },
  \ {'from' : 'a\m\v\M\V',
  \  'v' : '\va',
  \  'm' : '\ma',
  \  'M' : '\Ma',
  \  'V' : '\Va',
  \ },
  \ {'from' : '\m\v\M\V',
  \  'v' : '\v',
  \  'm' : '\m',
  \  'M' : '\M',
  \  'V' : '\V',
  \ },
  \ {'from' : '\\m',
  \  'v' : '\v\\m',
  \  'm' : '\m\\m',
  \  'M' : '\M\\m',
  \  'V' : '\V\\m',
  \ },
  \ ]

setlocal magic
for s:testcase2 in s:testcases2
  call s:test_magicalize(s:testcase2['from'], s:testcase2['m'], function('magicalize#magicalize'))
  call s:test_magicalize(s:testcase2['from'], s:testcase2['v'], function('magicalize#verymagicalize'))
  call s:test_magicalize(s:testcase2['from'], s:testcase2['M'], function('magicalize#nomagicalize'))
  call s:test_magicalize(s:testcase2['from'], s:testcase2['V'], function('magicalize#verynomagicalize'))
endfor



let s:testcases3 = [
  \ {'from' : '\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~^$',
  \  'v' : '\v(){}@%?=|+&<>.*~^$',
  \  'm' : '\m\(\)\{}\@\%\?\=\|\+\&\<\>.*~^$',
  \  'M' : '\M\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~^$',
  \  'V' : '\V\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~\^\$',
  \ },
  \ {'from' : '(){}@%?=|+&<>.*~\^\$',
  \  'v' : '\v\(\)\{}\@\%\?\=\|\+\&\<\>\.\*\~\^\$',
  \  'm' : '\m(){}@%?=|+&<>\.\*\~\^\$',
  \  'M' : '\M(){}@%?=|+&<>.*~\^\$',
  \  'V' : '\V(){}@%?=|+&<>.*~^$',
  \ },
  \ {'from' : 'a\m\v\M\V',
  \  'v' : '\va',
  \  'm' : '\ma',
  \  'M' : '\Ma',
  \  'V' : '\Va',
  \ },
  \ {'from' : '\m\v\M\V',
  \  'v' : '\v',
  \  'm' : '\m',
  \  'M' : '\M',
  \  'V' : '\V',
  \ },
  \ {'from' : '\\m',
  \  'v' : '\v\\m',
  \  'm' : '\m\\m',
  \  'M' : '\M\\m',
  \  'V' : '\V\\m',
  \ },
  \ ]

setlocal nomagic
for s:testcase3 in s:testcases3
  call s:test_magicalize(s:testcase3['from'], s:testcase3['m'], function('magicalize#magicalize'))
  call s:test_magicalize(s:testcase3['from'], s:testcase3['v'], function('magicalize#verymagicalize'))
  call s:test_magicalize(s:testcase3['from'], s:testcase3['M'], function('magicalize#nomagicalize'))
  call s:test_magicalize(s:testcase3['from'], s:testcase3['V'], function('magicalize#verynomagicalize'))
endfor

catch
  let &magic = s:save_magic
endtry

"}}}

